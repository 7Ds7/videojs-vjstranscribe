/*!
* videojs-vjstranscribe
* @author 7Ds7
* @version 1.0.1
* @url https://github.com/7Ds7/videojs-vjstranscribe.git
* Copyright 2023 GPLv3 licensed.
*/
(()=>{var c=class{selectorId;activeTrack;plugin;constructor(t,s,e){this.selectorId=t,this.activeTrack=s,this.plugin=e;let i=document.createElement("select");i.setAttribute("id",this.selectorId);for(let r=0;r<this.plugin.player.textTracks().tracks_.length;r++){let n=document.createElement("option");n.value=this.plugin.player.textTracks().tracks_[r].language,this.activeTrack===this.plugin.player.textTracks().tracks_[r]&&n.setAttribute("selected","selected"),n.textContent=this.plugin.player.textTracks().tracks_[r].label||this.plugin.player.textTracks().tracks_[r].language,i.appendChild(n)}if(i.addEventListener("change",this.changeSelector.bind(this)),!document.getElementById(this.selectorId)){let r=document.createElement("div");r.setAttribute("id",this.selectorId),this.plugin.player.el().insertAdjacentElement("afterend",r)}document.getElementById(this.selectorId).appendChild(i)}changeSelector(t){for(let s=0;s<this.plugin.player.textTracks().tracks_.length;s++){let e=this.plugin.player.textTracks().tracks_[s];document.getElementById(this.selectorId).querySelector(`option[value=${e.language}]`).removeAttribute("selected"),e.mode="disabled",(t.target&&e.language===t.target.value||t.language&&e.language===t.language)&&(document.getElementById(this.selectorId).querySelector(`option[value=${e.language}]`).setAttribute("selected","selected"),e.mode="showing")}}};var l=class{downloadId;activeTrack;plugin;constructor(t,s,e){this.downloadId=t,this.activeTrack=s,this.plugin=e,this.changeDownload(this.activeTrack)}changeDownload(t){this.activeTrack=t;let s;if(!document.getElementById(this.downloadId)){let e=document.createElement("div");e.setAttribute("id",this.downloadId),this.plugin.player.el().insertAdjacentElement("afterend",e)}if(s=document.getElementById(this.downloadId),s.innerHTML="",this.plugin.options.download){let e=document.createElement("a");e.setAttribute("href",this.activeTrack.src);let i=this.activeTrack.src.split(/[#?]/)[0].split(".").pop().trim();e.setAttribute("download",`${this.activeTrack.label}.${i}`),e.classList.add("vjs-transcribe-btn"),e.classList.add("vjs-transcribe-download"),e.setAttribute("title","Download");let r=document.createElement("span");r.classList.add("vjs-sr-only"),r.textContent="Download transcript",s.appendChild(e)}if(this.plugin.options.copy){let e=document.createElement("button");e.classList.add("vjs-transcribe-btn"),e.classList.add("vjs-transcribe-copy"),e.setAttribute("title","Copy");let i=document.createElement("span");i.classList.add("vjs-sr-only"),i.textContent="Copy",e.appendChild(i),e.addEventListener("click",r=>{let n="";document.querySelectorAll(".vjs-transcribe-cueline span:last-child").forEach(a=>{n+=a.textContent,n+=" "}),navigator.clipboard.writeText(n).then(a=>{console.log("copied to clipboard",a)},a=>{console.log("failed to copy to clipboard",a)})}),s.appendChild(e)}}};var d=class{widgetId;activeTrack;plugin;$body;constructor(t,s,e){if(this.widgetId=t,this.activeTrack=s,this.plugin=e,!document.getElementById(this.widgetId)){let i=document.createElement("div");i.setAttribute("id",this.widgetId),this.plugin.player.el().insertAdjacentElement("afterend",i)}this.createWidgetBody(this.activeTrack)}createWidgetBody(t){this.activeTrack=t,this.$body=document.createElement("div"),this.$body.classList.add("vjs-transcribe-body"),this.plugin.options.mode==="prose"&&this.$body.classList.add("vjs-transcribe-body-prose");let s,e,i=document.createDocumentFragment();for(e=0;e<this.activeTrack.cues.length;e++)s=this.createLine(this.activeTrack.cues[e]),i.appendChild(s);this.$body.innerHTML="",this.$body.appendChild(i),this.$body.setAttribute("lang",this.activeTrack.language),document.getElementById(this.widgetId).innerHTML="",document.getElementById(this.widgetId).appendChild(this.$body)}createLine(t){let s=document.createElement("div"),e=document.createElement("span"),i=document.createElement("span");return s.setAttribute("data-begin",t.startTime),s.classList.add("vjs-transcribe-cueline"),e.textContent=new Date(1e3*t.startTime).toISOString().substr(11,8).replace(/^[0:]+/,""),e.classList.add("vjs-transcribe-cuetimestamp"),i.innerHTML=this.plugin.parseTags(t.text),s.appendChild(e),s.appendChild(i),s.addEventListener("click",this.clickTimestamp.bind(this)),s}clickTimestamp(t){let s=t.target.getAttribute("data-begin")||t.target.parentElement.getAttribute("data-begin");s!=null&&this.plugin.player.currentTime(parseInt(s))}setCue(t){let s,e,i,r,n=this.$body.children,a=!1;for(s=0;s<n.length;s++)e=n[s],i=e.getAttribute("data-begin"),s<n.length-1?r=n[s+1].getAttribute("data-begin"):r=this.plugin.player.duration()||1/0,t>i&&t<r?e.classList.contains("cue-active")||(e.classList.add("cue-active"),a=!0):e.classList.remove("cue-active");let o=this.$body.querySelector(".cue-active");if(o&&a){let u={root:this.$body,rootMargin:"0px",threshold:0},m=new IntersectionObserver(b=>{b[0].intersectionRatio<1&&this.$body.scrollTo({top:o.offsetTop-this.$body.offsetTop-this.$body.offsetHeight+o.offsetHeight,left:0,behavior:"smooth"}),m.unobserve(o)},u);m.observe(o)}}};var h=class{searchId;activeTrack;plugin;$search;$searchInput;$resultsWrapper;$$cues;constructor(t,s,e){if(this.searchId=t,this.activeTrack=s,this.plugin=e,!document.getElementById(this.searchId)){let i=document.createElement("div");i.setAttribute("id",this.searchId),this.plugin.player.el().insertAdjacentElement("afterend",i)}this.$search=document.getElementById(this.searchId),this.$search.classList.add("vjs-transcribe-search"),this.$searchInput=document.createElement("input"),this.$searchInput.setAttribute("role","searchbox"),this.$searchInput.setAttribute("type","search"),this.$searchInput.setAttribute("placeholder","Search"),this.$searchInput.addEventListener("keyup",this.searchStart.bind(this)),this.$searchInput.addEventListener("focus",this.searchStart.bind(this)),this.$search.appendChild(this.$searchInput),this.$resultsWrapper=document.createElement("div"),this.$resultsWrapper.classList.add("vjs-transcribe-search-results"),this.$resultsWrapper.classList.add("vjs-transcribe-hide"),this.$search.appendChild(this.$resultsWrapper),window.addEventListener("click",this.closeHandler,!1)}closeHandler=this.closeSearch.bind(this);removeEv(){window.removeEventListener("click",this.closeHandler,!1)}closeSearch(t){!this.$search.querySelector(".vjs-transcribe-search-results").classList.contains("vjs-transcribe-hide")&&t.target.closest(`#${this.searchId}`)===null&&(this.$resultsWrapper.classList.add("vjs-transcribe-hide"),this.$resultsWrapper.innerHTML="")}searchStart(t){t.target.value&&t.target.value.length>0&&(this.$$cues=this.queryCueLines(`#${this.plugin.options.widgetId} .vjs-transcribe-cueline`,t.target.value),this.$resultsWrapper.innerHTML="",this.generateResults(t.target.value),this.$resultsWrapper.classList.remove("vjs-transcribe-hide"))}generateResults(t){if(this.$$cues.length==0){let s=document.createElement("div");return s.classList.add("vjs-transcribe-search-result"),s.textContent="No results found",this.$resultsWrapper.appendChild(s),!1}this.$$cues.forEach((s,e)=>{let i=document.createElement("span");i=this.plugin.parseTags(s.querySelector("span:last-child").textContent);let r=(o,u)=>o.replace(RegExp(u,"gi"),`<b>${u}</b>`),n=document.createElement("span");n.innerHTML=r(i,t);let a=document.createElement("button");a.classList.add("vjs-transcribe-search-result"),a.dataset.index=e,a.appendChild(n),a.addEventListener("click",this.selectResult.bind(this)),this.$resultsWrapper.appendChild(a)})}selectResult(t){let s=t.currentTarget;this.$$cues[s.dataset.index].dispatchEvent(new Event("click")),this.$resultsWrapper.classList.add("vjs-transcribe-hide")}queryCueLines(t,s){var e=document.querySelectorAll(t);return Array.prototype.filter.call(e,function(i){return RegExp(s,"i").test(i.textContent)})}};typeof videojs>"u"&&console.warn("vjstranscribe videojs not detected");var g=videojs.getPlugin("plugin"),v=class extends g{defaultOptions={customClass:"vjs-transcribe",widgetId:"vjs-transcribe",selector:!0,selectorId:"vjs-transcribe-selector",download:!0,copy:!0,downloadId:"vjs-transcribe-download",search:!0,searchId:"vjs-transcribe-search",pip:!0,pipId:"vjs-transcribe-pip",mode:"line",disablecc:!0};activeTrack;selectorComponent;widgetComponent;downloadComponent;searchComponent;$initialParent;activated=!1;totalTracks=0;constructor(t,s){super(t,s),this.options={...this.defaultOptions,...s},t.addClass(this.options.customClass),this.on(t,"ready",function(){if(this.getActiveTrack()){let e=videojs.getComponent("Button"),i=new e(t,{className:"vjs-transcribe-btn",controlText:"Transcript",clickHandler:r=>{this.activated?this.destroyTranscript():this.createTranscript(t)}});t.getChild("ControlBar").el().insertBefore(i.el(),t.getChild("ControlBar").getChild("subsCapsButton").el())}}),this.on(t.textTracks(),"change",function(e){let i=this.getActiveTrack();i.activeCues&&this.widgetComponent&&i!==this.widgetComponent.activeTrack&&(this.widgetComponent.createWidgetBody(i),this.options.selector&&this.totalTracks>0&&this.selectorComponent.changeSelector(i),this.downloadComponent&&this.downloadComponent.changeDownload(i))}),this.on(t,"timeupdate",function(){this.activated&&this.widgetComponent&&this.widgetComponent.setCue(t.currentTime())})}getActiveTrack(){let t,s;for(t=0;t<this.player.textTracks().tracks_.length;t++)s=this.player.textTracks().tracks_[t],s.mode==="showing"&&(this.activeTrack=s);return this.activeTrack||this.player.textTracks().tracks_[0]}createTranscript(){let t=this.getActiveTrack(),s=this;if(this.activated=!0,this.totalTracks=this.player.textTracks().length,!t.activeCues)window.setTimeout(function(){s.createTranscript()},100);else{if(this.options.selector&&this.totalTracks>1&&(this.selectorComponent=new c(this.options.selectorId,t,this)),this.options.search&&(this.searchComponent=new h(this.options.searchId,t,this)),(this.options.download||this.options.copy)&&(this.downloadComponent=new l(this.options.downloadId,t,this)),this.widgetComponent=new d(this.options.widgetId,t,this),this.player.el().classList.add("vjs-transcribe-active"),this.options.pip){this.$initialParent=this.player.el().parentElement;let e=this.getPip();e.appendChild(this.player.el()),e.classList.add("vjs-transcribe-pip"),e.classList.add("pip-active")}this.options.disablecc&&(this.player.el().querySelector(".vjs-text-track-display").style.display="none"),window.dispatchEvent(new Event("vjstranscribe.on"))}}getPip(){if(!document.getElementById(this.options.pipId)){let t=document.createElement("div");t.setAttribute("id",this.options.pipId),this.player.el().insertAdjacentElement("afterend",t)}return document.getElementById(this.options.pipId)}parseTags(t){let s=document.createElement("textarea");s.innerHTML=t;let e=new DOMParser().parseFromString(s.value,"text/html");return e.body.textContent||e.body.innerText||""}destroyTranscript(){this.activated=!1,this.widgetComponent=void 0,this.activeTrack=void 0,this.player.el().classList.remove("vjs-transcribe-active"),document.getElementById(this.options.widgetId).innerHTML="",(this.options.download||this.options.copy)&&(this.downloadComponent=void 0,document.getElementById(this.options.downloadId).innerHTML=""),this.options.selector&&this.totalTracks>0&&(this.selectorComponent=void 0,document.getElementById(this.options.selectorId).innerHTML=""),this.options.search&&(this.searchComponent.removeEv(),this.searchComponent=void 0,document.getElementById(this.options.searchId).innerHTML=""),this.options.pip&&this.$initialParent.insertBefore(this.player.el(),this.$initialParent.firstChild),this.options.disablecc&&(this.player.el().querySelector(".vjs-text-track-display").style.display="block"),this.options.pip&&this.getPip().classList.remove("pip-active"),window.dispatchEvent(new Event("vjstranscribe.off"))}};videojs.registerPlugin("vjstranscribe",v);})();
